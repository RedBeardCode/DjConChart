{% extends "new_base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% block adminscripts %}
    <script type="text/javascript">window.__admin_media_prefix__ = "{% static "admin/" %}";</script>
    <script type="text/javascript">window.__admin_utc_offset__ = "0";</script>


    <script type="text/javascript" src="/admin/jsi18n/"></script>
    <script type="text/javascript" src="{% static "admin/js/core.js" %}"></script>
    <script type="text/javascript" src="{% static "admin/js/admin/RelatedObjectLookups.js" %}"></script>
    <script type="text/javascript" src="{% static "admin/js/actions.js" %}"></script>
    <script type="text/javascript" src="{% static "admin/js/related-widget-wrapper.js" %}"></script>

{% endblock %}
{% block form_content %}
    <form enctype="multipart/form-data" method="post">
        {% csrf_token %}

        {{ form|crispy }}

{% endblock %}

{% block inlinescripts %}
    <script type="text/javascript">

        function init_select(select_id, itemlist) {
            var sel_items = $(select_id).val();
            $(select_id).children().remove();
            for (var item in itemlist) {
                var value = itemlist[item][0];
                if (sel_items != null && sel_items.indexOf(value.toString()) >= 0) {
                    $(select_id).append("<option value='" + value + "' selected='selected'>" + itemlist[item][1] + "</option>");

                }
                else {
                    $(select_id).append("<option value='" + value + "'>" + itemlist[item][1] + "</option>");
                }
            }
            $(select_id).select(sel_items)
        }
        function get_order_items() {
            var order_pk = $('#id_order').val();
            $.ajax({
                url: '{% url "get_order_info" %}',
                success: function (data, textStatus, XMLHttpRequest) {
                    init_select("#id_order_items", data.order_items);
                    init_select("#id_measurement_devices", data.meas_devices);
                    init_select("#id_meas_item", data.meas_items);
                },
                type: 'POST',
                data: {order: order_pk},
                datatype: 'JSON',
            });
        }
        $(document).ready(function () {
            var order_pk = $("#id_order").val();


            init_ajax_csrf();
            if (order_pk) {
                get_order_items();

            }
            else {
                $("#id_order_items").children().remove();
                $("#id_meas_item").children().remove();
                $("#id_measurement_devices").children().remove();

                $("#id_order_items").append("<option value='-1'> Please select first the order</option>");
                $("#id_meas_item").append("<option value='-1'> Please select first the order</option>");
                $("#id_measurement_devices").append("<option value='-1'> Please select first the order</option>");
            }
        });
    </script>
{% endblock %}
